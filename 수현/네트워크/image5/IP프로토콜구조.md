# 멀리 있는 컴퓨터끼리는 이렇게 데이터를 주고 받는다 

## INDEX..

1. IPv4 프로토콜 : IPv4가 하는 일, IPv4 프로토콜의 구조
2. ICMP 프로토콜 : ICMP가 하는 일, ICMP 프로토콜의 구조
3. 라우팅 테이블 : 내가 보낸 패킷은 어디로 가는가
4. 다른 네트워크와 통신 과정 : 다음 네트워크까지 내 패킷의 이동 과정
5. IPv4의 조각화 : 조각화란?, 조각화하는 과정
6. 따라학 IT : 라우팅 테이블 확인해보가, 패킷 분석하기


### IPv4 프로토콜

1. IPv4가 하는 일
- 네트워크 상에서 데이터를 교환하기 위한 프로토콜
- 데이터가 <strong>정확하게 전달될 것을 보장하지 않는다</strong> 데이터가 누락되거나 깨질 수도 있다고 함.. 당황스...
- 중복된 패킷을 전달하거나 패킷의 순서를 잘못 전달할 가능성도 있다(악의적으로 이용되면 Dos 공격이 됨)
- 데이터의 정확하고 순차적인 전달은 그보다 상위 프로토콜인 TCP에서 보장한다

2. IPv4의 구조

![alt text](image.png)

``` md
- 마지막 줄은 추가적으로 붙을 수도 있고 아닐 수도 있음
- IPv4는 20바이트라고 생각하면 된다
- 출발지, 목적지 주소에 4바이트씩 각각 든다
- 첫번째는 버전(4또는 6이지만 무조건 4... 6이 오는 경우는 구조 자체가 아예 다름)
- IPv4 프로토콜의 헤더의 길이 : 4비트(2진수 4개.. 1111 -> 15)
- TOS(주고 받는 데이터의 형식) : 굉장히 옛날 값... 0으로 비워둔다
- Total Length : 상위 계층에서 부터 내려온 데이터 그냥 다 전체의 길이..
- Identification, flag, Fragment Offset은 하나의 세트
- Identification : 쪼개진 여러개의 패킷이 원래는 하나였다는 것을 알 수 있도록 id를 식별할 수 있는것..
- IP Flags : 3비트로 이루어져 있고 D는 패킷을 보내는 사람이 데이터를 안 쪼개서 보내겠다고 명시... 근데 이렇게 지정하면 전송이 안된다는데 뭐야~~ 거의 안 쓴다고 함..., M밖에 안 씀.. 조각화가 일어났다는 말이심..
- Fragment Offset : 13비트, 원래로 복구할때 순서가 있을거 아님 받을 때는 어떤 순서로 받아야 할지 모르자나.. 조립을 똑바로 해야하자나.. 이 순서를 알아볼 수 있도록 offset을 지정(시작 부분으로 부터 얼마나 떨어져 있는지를 지정한다라고)
- TTL(Time To Live) : 패킷이 살아있을 수 있는 시간(시간이 줄어들다가 없어지면 버려버린다 -> 죽었다고 표현함), 상대방의 운영체제를 알 수 있다!
- Protocol : 이더넷에 상위 프로토콜이 뭔지 알려주는 것
- Header Checksum : 헤더에 오류가 있는지 없는지 체크하는 값(내가 계산한 값이 세팅한 값이랑 다르면 오류..), 자동으로 컴퓨터가 알아서 한다
```


### ICMP 프로토콜

1. ICMP가 하는 일

- ICMP(Internet Control Message Protocol, 인터넷 제어 메시지 프로토콜)
- 네트워크 컴퓨터 위에서 돌아가는 운영체제에서 오류 메시지를 전송 받는 데 주로 쓰인다
- 프로토콜 구조의 Type과 Code를 통해 오류 메시지를 전송 받는다

2. ICMP 프로토콜의 구조

![alt text](image-1.png)
![alt text](image-2.png)

```
Type : 카테고리(개분류), 많아요 아주... 너무...(0 - 응답, 8 - 요청, 3 - 목적지에 도달할 수 없다, 11 - 요청 시간이 만료되었습니다(약간 대표적인 예가... 상대방이 요청을 보냈는데 내 방화벽으로 씹은 경우..), 5 - 원격지에 있는 상대방의 라우팅 테이블을 ICMP가지고 수정할 떄 사용... 정도는 알아 두시기를..) -> 네트워크 엔지니어가 이것만 보고 알 수 있다
Code : 타입의 소분류.. 
```


### 라우팅 테이블

1. 내가 보낸 패킷은 어디로 가는가...?

- 라우팅 테이블  : 어디로 보내야 하는지 설정되어 있는 테이블
<br>

![alt text](image-3.png)

- 라우팅 테이블에 적혀있는 네트워크 대역만 찾아갈 수 있다(지도가 있어야지만 해당하는 위치를 찾아갈 수 있다)
- 네트워크 장비 배울 때 테이블을 좀 더 자세히 배운다고 함..



### 다른 네트워크와 통신 과정

1. 다른 네트워크까지 내 패킷의 이동 과정

<br>

![alt text](image-4.png)

- A가 B랑 통신하려고 하면....

1. B의 네트워크 대역이 A의 라우팅 테이블 안에 있어야지만 통신할 수 있다
2. 절로 가면 된다고 ICMP 요청 프로토콜을 만든다(요청 - 8)
<br>

![alt text](image-5.png)

3. 가장 가까운 c한테 먼저 보낸다(맥주소에 최종 주소를 넣는게 아님)
4. 근데 b는 목적지의 ip 주소가 자기가 아님을 확인하고 본인의 라우팅 테이블을 확인하고 이더넷 프로토콜을 다시 만드는데 출발지 맥주소와 목적지 맥주소를 변경해서 다시 만든다!!
5. 또다시 이더넷 프로토콜을 짜고 또 짜면 b가 받는다.... 진짜 복잡스
6. b가 요청을 받은거니까 응답을 해줘야 한다, 0번으로 응답을 해주는데 줬던 반대 방향으로 이뤄지면 되겠져
    - 근데 이 과정에서 mac 주소를 모르면 arp 프로토콜을 사용하는 과정이 추가된다

- 내 본체의 라우팅 테이블...
![alt text](image-6.png)



### IPv4의 조각화 

1. 조각화란?

- 큰 IP 패킷들은 적은 MTU(Maximum Transmission Unit)를 갖는 링크를 통하여 전송되려면 여러 개의 작은 패킷으로 쪼개어 / 조각화 되어 전송돼야 한다
- 즉, 목적지까지 패킷을 전달하는 과정에 통과하는 각 라우터마다 전송에 적합한 프레임으로 변환이 필요하다
- 일단 조각화되면, 최종 목적지에 도달할 때까지 재조립되지 않는 것이 일반적이다

- IPv4에서는 발신지 뿐만 아니라 중간 라우터에서도 IP 조각화가 가능
- IPv6에서는 IP 단편화가 발신지에서 만 가능
- 재조립은 항상 최종 수신지에서 만 가능함
<br>

![alt text](image-7.png)

2. 큰 데이터를 전송하는 패킷이 조각화 하는 과정

<br>

![alt text](image-8.png)

![alt text](image-9.png)

![alt text](image-10.png)