# 4장 데이터베이스
## 4.3. 트랜잭션과 무결성


### (1) 트랜잭션
- 트랜잭션: 데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위
    - 여러 개의 쿼리들을 하나로 묶는 단위
    - 특징: 원자성, 일관성, 독립성, 지속성 -> "ACID"
        - 1. 원자성
            - "all or nothing"
            - 트랜잭션과 관련된 일이 모두 수행되었거나 되지 않았거나를 보장하는 특징
            - 트랜잭션 단위로 여러 로직들을 묶을 때 외부 API를 호출하는 것이 있으면 안 됨
            - 커밋과 롤백 -> 데이터의 무결성 보장, 변경 사항 쉽게 확인, 해당 작업 그룹화 가능
                - 커밋
                    - 여러 쿼리가 성공저긍로 처리되었다고 확정하는 명령어
                    - 트랜잭션 단위로 수행
                    - 변경된 내용이 모두 영구적으로 저장
                - 롤백
                    - 트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 일(취소)
            - 트랜잭션 전파
                - 트랜잭션 수행 시 커넥션 객체를 넘기지 않고 여러 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것

            ```java
            @Service
            @Transactional(readOnly=true)
            public class MemberService {
                private final   MemberRepository memberRepository;

                public MemberService(MemberRepository memberRepository) {
                    this.memberRepository = memberRepository;
                }
            }

            ```
                
        - 2. 일관성
            - 허용된 방식으로만 데이터를 변경해야 하는 것
            - DB에 기록된 모든 데이터는 여러 가지 조건, 규칙에 따라 유효함을 가져야 함
        - 3. 격리성
            - 트랜잭션 수행 시 서로 끼어들지 못하는 것
                - 복수의 병렬 트랜잭션 -> 서로 격리되어 마치 순차적으로 실행되는 것처럼 작동                                              
                - DB는 여러 사용자가 같은 데이터에 접근할 수 있어야 함
            - 동시성과 격리성은 반비례
            - 격리 수준에 따라 발생하는 현상
                - ㄱ. 팬텀 리드(phantom read)
                    - 한 트랜잭션 내에서 동일한 쿼리를 보냈을 때 해당 조회 결과가 다른 경우
                    - 다른 행이 선택될 수도 있음
                - ㄴ. 반복 가능하지 않은 조회(non-repeatable read)
                    - 한 트랜잭션 내의 같은 행에 두 번 이상 조회 발생 -> 그 값이 다른 경우
                    - 행 값이 달라질 수도 있음
                - ㄷ. 더티 리드(dirty read)
                    - 반복 가능하지 않은 조회와 유사하며 한 트랜잭션이 실행 중일 때 다른 트랜잭션에 의해 수정되었지만, 아직 커밋되지는 않은 행의 데이터를 읽을 수 있을 때 발생
                    - 즉 변경만 하고 커밋은 안 한 상태인데, 해당 데이터를 읽으면 변경 내용으로 조회됨
            - 격리 수준
                - ㄱ. SERIALIZABLE
                    - 트랜잭션을 순차적으로 진행시키는 것
                    - 여러 트랜잭션이 동시에 같은 행에 접근할 수 없음
                - ㄴ. REPEATABLE_READ
                    - 하나의 트랜잭션이 수정한 행을 다른 트랜잭션이 수정할 수 없도록 막아 주지만, 새로운 행의 추가는 막지 않음
                - ㄷ. READ_COMMITED
                    - 가장 많이 사용되는 격리 수준
                    - 여러 RDBMS에서 기본값으로 설정됨
                    - 다른 트랜잭션이 커밋하지 않은 정보는 읽을 수 없음 -> 커밋 완료된 데이터에 대해서만 조회 허용
                    - 어떤 트랜잭션이 접근한 행을, 다른 트랜잭션이 수정할 수는 있음
                - ㄹ. READ_UNCOMMITED
                    - 가장 낮은 격리 수준
                    - 하나의 트랜잭션이 커밋되기 이전에 다른 트랜잭션에 노출되는 문제가 있으나, 가장 빠름
                    - 데이터 무결성을 지키기 위해 되도록 사용하지 않는 것이 이상적
                    - BUT 거대한 양의 데이터를 '어림잡아' 집계하는 데 사용하기엔 GOOD
        - 4. 지속성
            - 성공적으로 수행된 트랜잭션은 영원히 반영되어야 하는 것
            - DB에 시스템 장애 발생해도 원래 상태로 복구하는 회복 기능이 있어야 함을 뜻함
            - 이를 위해 체크섬, 저널링, 롤백 등의 기능을 제공
                                                    

### (2) 무결성
- 무결성: 데이터의 정확성, 일관성, 유효성을 유지하는 것
- 무결성이 유지되어야 DB에 저장된 데이터 값과 그 값에 해당하는 현실 세계의 실제 값이 일치하는지에 대한 신뢰가 생김
- 종류
    - 1. 개체 무결성: 기본키로 선택된 필드는 빈 값 허용X
    - 2. 참조 무결성: 서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지
    - 3. 고유 무결성: 특정 속성에 대해 고유한 값을 가지도록 조건이 주어진 경우 그 속성 값은 모두 고유한 값을 가짐
    - 4. NULL 무결성: 특정 속성 값에 NULL이 올 수 없다는 조건이 주어진 경우 그 속성 값은 NULL이 될 수 없다는 제약 조건