# 3장 운영체제
## 3.3. 프로세스와 스레스
- 프로세스: 컴퓨터에서 실행되고 있는 프로그램을 의미
    - CPU 스케줄링의 대상이 되는 작업(task)이라는 용어와 거의 같은 의미로 사용됨
- 스레드: 프로세스 내 작업의 흐름

### (1) 프로세스와 컴파일 과정
- 프로세스: 프로그램으로부터 인스턴스화된 것
- 컴파일 과정
    - ㄱ. 전처리
    - ㄴ. 컴파일러
    - ㄷ. 어셈블러
    - ㄹ. 링커

### (2) 프로세스의 상태
- 생성 상태
    - 프로세스가 생성된 상태 
    - fork() 또는 exec() 텅헤 생성
        - fork(): 부모 프로세스의 주소 공간을 그대로 복사, 새로운 자식 프로세스를 생성하는 함수
        - exex(): 새롭게 프로세스를 생성하는 함수
    - PCB 할당됨

- 대기 상태
    - 메모리 공간 충분 -> 메모리 할당 받고, 불충분 -> 대기 상태
    - CPU 스케줄러로부터 CPU 소유권이 넘어오기를 기다리는 상태

- 대기 중단 상태 
    - 메모리 부족으로 일시 중단된 상태

- 실행 상태
    - CPU 소유권과 메모리를 할당받고 인스트럭션을 수행 중인 상태 -> "CPU burst가 일어났다"

- 중단 상태
    - 어떤 이벤트 발생 이후 기다리며 프로세스가 차단된 상태
    - I/O 디바이스에 의한 인터럽트로 이런 현상이 많이 발생
        - ex. 프린터 인쇄 버튼 -> 프로세스가 잠깐 멈춘 듯 

- 일시 중단 상태
    - 대기 중단과 유사
    - 중단 상태에서 프로세스가 실행되려고 했지만 메모리 부족으로 일시 중단된 상태

- 종료 상태
    - 메모리와 CPU 소유권을 모두 놓고 가는 상태
    - 자연스럽게 종료
    - 비자발적 종료(abort) : 부모 프로세스가 자식 프로세스를 강종

### (3) 프로세스의 메모리 구조
- 동적 영역
    - 스택
        - 지역변수, 매개변수, 함수 저장
        - 컴파일 시 크기 결정됨
    - 힙
        - 동적 할당 시 사용
        - 런타임 시 크기 결정됨
- 정적 영역
    - 데이터 영력
        - 전역변수, 정적 변수 저장
        - 정적 특징을 갖는 프로그램이 종료되면 사라지는 변수가 들어 있는 영역
        - BSS 영역
            - 초기화되지 않은 변수가 0으로 초기화되어 저장됨
        - Data 영역
            - 0이 아닌 다른 값으로 할당된 변수들이 저장됨
    - 코드 영역
        - 프로그램에 내장되어 있는 소스 코드가 들어가는 영역
        - 수정 불가능한 기계어로 저장되어 있음

### (4) PCB(Process Control Block)
- 운영체제에서 프로세스에 대한 메타데이터를 저장한 '데이터'를 의미
- 프로세스 제어 블록이라고도 함
- 프로세스 생성 시 운영체제는 해당 PCB를 생성
- 간단 과정
    - 프로그램 실행 -> 프로세스 생성
    - 자료구조(스탭, 힙 등) 기반으로 프로세스 주소 값들에 메모리가 할당됨
    - 해당 프로세스의 메타 데이터들이 PCB에 저장 및 관리됨
- 커널 스택의 가장 앞부분에서 관리 -> 일반 사용자가 접근하지 못하도록!
- PCB의 구조
    - 프로세스 스케줄링 상태
    - 프로세스 ID
    - 프로세스 권한
    - 프로그램 카운터
    - CPU 레지스터
    - CPU 스케줄링 정보
    - 계정 정보
    - I/O 상태 정보

- 컨텍스트 스위칭(Context Switching)
    - PCB를 교환하는 과정
    - 싱글 코어 기준, 어떠한 시점에서 실행되고 있는 프로세스는 단 한 개 -> 여러 개 동시 구동처럼 보이는 이유는 다른 프로세스와의 "컨텍스트 스위칭"이 매우 빠르게 실행되기 때문
    - 비용
        - 유휴 시간
        - 캐시미스
            - 컨텍스트 스위칭 일어날 때 주소 바꾸려고 캐시클리어 -> 캐시미스 발생
    - 스레드에서도 컨텍스트 스위칭 발생
        - 스택 영역 제외 모든 메모리 공유 -> 상대적으로 비용 및 시간이 적음

### (5) 멀티프로세싱
- 멀티프로세스를 통해 동시에 두 가지 이상의 일을 수행할 수 있는 것 -> 하나의 일을 병렬로 처리 가능
- 프로세스 중 일부 문제가 생기더라도 다른 프로세스 통해 처리 -> 신뢰성 높음
- ㄱ. 웹 브라우저
    - 구조
        - 브라우저 프로세스
        - 렌더러 프로세스
        - 플러그인 프로세스
        - GPU 프로세스
- ㄴ. IPC(Inter Process Communication)
    - 프로세스끼리 데이터를 주고받고 공유 데이터를 관리하는 메커니즘
    - ex. 클라이언트(데이터 요청) - 서버(그 요청에 응답)
    - 종류
        - 공유 메모리
            - 여러 프로세스에 동일한 메모리 블록에 대한 접근 권한 부여 -> 프로세스가 서로 통신할 수 있도록 공유 버퍼 생성
            - 기본적으로 프로세스는 서로의 메모리에 접근 불가함 BUT 공유 메모리를 통해 여러 프로세스가 하나의 메모리 공유 가능
            - 메모리 자체를 공유하기에 불필요한 데이터 복사 오버헤드 발생X -> 가장 빠름
            - 동기화 필요
        - 파일
            - 디스크에 저장된 데이터 또는 파일 서버에서 제공한 데이터
        - 소켓
            - 동일한 컴퓨터의 다른 프로세스나 네트워크의 다른 컴퓨터로 네트워크 인터페이스를 통해 전공하는 데이터
            - TCP, UDP
        - 익명 파이프
            - 파이프(FIFO 방식으로 읽히는 임시 공간)를 기반으로 데이터를 주고 받으며, 단방향 방식의 읽기 전용, 쓰기 전용 파이프를 만들어 작동하는 방식
        - 명명된 파이프
            - 파이프 서버와 하나 이상의 파이프 클라이언트 간의 통신을 위한 단방향 또는 이중 파이프
            - 클라이언트/서버 통신 위한 별도의 파이프 제공
            - 여러 파이프 동시 사용 가능
        - 메시지 큐
            - 메시지를 큐 데이터 구조 형태로 관리하는 것
            - 커널에서 전역적으로 관리됨
            - 다른 방법들에 비해 매우 직관적이고 간단 -> 간단히 메시지 큐에 접근할 수 있는 장점
            - 공유 메모리 통한 IPC 구현 시 동기화 때문에 일이 좀 복잡해짐 -> 그것의 대안으로 메시지 큐 사용


### (6) 스레드와 멀티스레딩
- 스레드: 프로세스의 실행 가능한 가장 작은 단위
    - 코드, 데이터, 힙을 스레드끼리 서로 공유하고 그 외 영역은 각각 생성
- 멀티 스레딩
    - 프로세스 내 작업을 여러 개의 스레드, 멀티스레드로 처리하는 기법
    - 스레드끼리 서로 자원을 공유하기 때문에 효율성이 높음
    - 한 스레드가 중단(blocked)되어도 다른 스레드는 실행 상태(running)일 수 있음 -> 빠른 처리
    - 단점: 한 스레드 문제 발생 -> 다른 스레드에도 영향 -> 프로세스에 영향 

### (7) 공유 자원과 임계 영역
- 공유 자원
    - 시스템 안에서 각 프로세스, 스레드가 함께 접근할 수 있는 모니터, 프린터, 메모리, 파일, 데이터 등의 자원이나 변수 등
    - 경쟁 상태: 공유 자원을 두 개 이상의 프로세스가 동시에 읽거나 쓰는 상황
        - 동시 접근 시도 시, 접근 타이밍이나 순서 등이 결괏값에 영향을 줄 수 있는 상태
- 임계 영역(critical section)
    - 공유 자원에 접근할 때 순서 등의 이유로 결과가 달라지는 영역
    - 해결 방법 -> 상호 배제, 한정 대기, 융통성 조건 all 만족
        - 뮤텍스
            - 공유 자원 사용 전에 설정하고, 사용 후에 해제하는 잠금
            - 하나의 상태(잠금 or 잠금 해제)만 가짐
        - 세마포어
            - 일반화된 뮤텍스
            - 간단한 정수 값과 두 가지 함수로 공유 자원에 대한 접근 처리
                - wait(): 자신의 차례가 올 때까지 기다림
                - signal(): 다음 프로세스로 순서를 넘겨줌
            - ㄱ. 바이너리 세마포어
                - 0과 1의 두 가지 값만 가질 수 있는 세마포어
            - ㄴ. 카운팅 세마포어   
                - 여러 개의 값을 가질 수 있는 세마포어
        - 모니터
            - 둘 이상의 스레드나 프로세스가 공유 자원에 안전하게 접근할 수 있도록 공유 자원을 숨기고, 해당 접근에 대한 인터페이스만 제공

### (8) 교착 상태
- 두 개 이상의 프로세스들이 서로가 가진 자원을 기다리며 중단된 상태
- 원인
    - 상호 배제
    - 점유 대기
    - 비선점
    - 환형 대기
- 해결 방법
    - ㄱ. 자원 할당 시 애초에 조건이 성립되지 않도록 설계
    - ㄴ. 교착 상태 가능성이 없을 때만 자원 할당. 은행원 알고리즘(프로세스당 요청할 자원들의 최대치를 통해 자원 할당 가능 여부 파악) 사용
    - ㄷ. 교착 상태 발생 시 사이클이 있는지 찾고, 관련 프로세스 하나씩 지움
    - ㄹ. 교착 상태는 매우 드묾 -> 처리 비용이 큰 편 -> 발생 시 그냥 사용자가 작업 종료하기(현대 응용체제가 채택한 방법ㅋㅋ)